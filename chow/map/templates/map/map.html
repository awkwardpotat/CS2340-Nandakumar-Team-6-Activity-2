{% extends "base.html" %}
{% block content %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <div class="container mt-4">
  <h1>Restaurant Map</h1>
  <p class="text-muted">Click on a marker to view restaurant details. Click on any location to mark a new restaurant.</p>
  <div id="map" data-authenticated="{{ is_authenticated|yesno:'true,false' }}" style="height: 600px; width: 100%; border-radius: 5px; border: 1px solid #ccc;"></div>
</div>

<script>
  // Initialize map centered on USA
  const map = L.map('map').setView([39.8283, -98.5795], 4);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);

  // Add restaurant markers
  const restaurants = JSON.parse('{{ restaurants_json|escapejs }}');
  restaurants.forEach(function(restaurant) {
    if (restaurant.latitude && restaurant.longitude) {
      const marker = L.marker([restaurant.latitude, restaurant.longitude]).addTo(map);
      marker.bindPopup(
        '<strong>' + restaurant.name + '</strong><br>' +
        'Rating: ' + (restaurant.average_rating || 'N/A') + '<br>' +
        '<a href="/restaurants/' + restaurant.id + '/">View Details</a>'
      );
    }
  });

  // Try to geolocate user
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(position => {
      map.setView([position.coords.latitude, position.coords.longitude], 10);
    });
  }

  // If user is authenticated, allow clicking map to create a new restaurant
  const mapEl = document.getElementById('map');
  const isAuthenticated = mapEl && mapEl.dataset && mapEl.dataset.authenticated === 'true';
  if (isAuthenticated) {
    map.on('click', function(e) {
      const lat = e.latlng.lat.toFixed(6);
      const lng = e.latlng.lng.toFixed(6);
      if (confirm('Create a restaurant at this location?')) {
        // Redirect to restaurant create page with lat/lng as query params
        window.location.href = "{% url 'restaurants.create' %}?lat=" + lat + '&lng=' + lng;
      }
    });
  }
</script>
{% endblock content %}